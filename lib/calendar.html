<section class="apocCalendar-Component_Box">
	<header class="apocCalendar-Component_Header">{{head(year, month + 1)}}</header>
	<Month :store :day :minDate :maxDate pagerStep="{{pager.step}}" />
	{{#if pager.prev}}
		<Pager :store :onClickPagerPrev step="{{pager.step}}" />
	{{/if}}

	{{#if pager.next}}
		<Pager :store type="right" :onClickPagerNext step="{{pager.step}}" />
	{{/if}}
</section>

<script>
import pupa from 'pupa';
import CalendarStore from './store'
import Month from './month.html'
import Pager from './pager.html'

const store = new CalendarStore();
if (process.env.NODE_ENV !== 'production') {
	window.store = store;
}

export default {
	components: {
		Month,
		Pager,
	},
	data() {
		const todayDate = new Date();
		const nextYearDate = new Date(
			todayDate.getFullYear() + 1,
			todayDate.getMonth(),
			todayDate.getDate()
		);

		return {
			store,
			min: todayDate,
			max: nextYearDate,
			pager: {
				prev: true,
				next: true,
				step: 1,
			},
			onClickPagerPrev: (step = 1) => {
				store.prev(step);
			},
			onClickPagerNext: (step = 1) => {
				store.next(step);
			},
			head: (year, month) => `${year}.${month}`,
			day: day => {
				switch (day) {
					case 0: {
						return '日';
					}
					case 1: {
						return '月';
					}
					case 2: {
						return '火';
					}
					case 3: {
						return '水';
					}
					case 4: {
						return '木';
					}
					case 5: {
						return '金';
					}
					case 6: {
						return '土';
					}
					default: {
						throw new Error('err');
					}
				}
			},
		};
	},
	computed: {
		minDate: min => {
			const date = new Date(min);
			return {
				year: date.getFullYear(),
				month: date.getMonth(),
				date: date.getDate(),
				day: date.getDay(),
			};
		},
		maxDate: max => {
			const date = new Date(max);
			return {
				year: date.getFullYear(),
				month: date.getMonth(),
				date: date.getDate(),
				day: date.getDay(),
			};
		}
	},
	helpers: {
		headText(template, year, month) {
			return pupa(template, {
				year: year,
				month: month + 1,
			});
		},
	},
	methods: {
		reset() {
			store.reset(this.step);
		}
	},
	oncreate() {
		store.observe('year', year => {
			this.set({year});
		});

		store.observe('month', month => {
			this.set({month});
		});

		const handleChange = () => {
			const data = store.exportData();
			if (data.length === 0) {
				return;
			}
			this.fire('change', {data});
		}

		store.observe('currentDates', handleChange);
		store.observe('data', handleChange);
	}
};
</script>

<style>
.apocCalendar-Component_Box {
	position: relative;
	font-size: 1em;
	/* padding: 0 2em; */
	box-sizing: border-box;
	background: #444;
	border: 1px solid #444;
}

.apocCalendar-Component_Header {
	font-size: 1.2em;
	font-weight: bold;
	line-height: 4;
	margin-bottom: 1px;
	background: #fff;
	user-select: none;
}
</style>
